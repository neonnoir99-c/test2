<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Audio Scheduler Demo - Precise 120 BPM Timing</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a1a;
      color: #fff;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    .container {
      max-width: 1000px;
      width: 100%;
    }

    h1 {
      margin-bottom: 10px;
      font-size: 28px;
    }

    .subtitle {
      color: #888;
      margin-bottom: 30px;
    }

    .controls {
      background: #2a2a2a;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: background 0.2s;
    }

    button:hover {
      background: #45a049;
    }

    button:active {
      transform: scale(0.98);
    }

    button.stop {
      background: #f44336;
    }

    button.stop:hover {
      background: #da190b;
    }

    .bpm-control {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .bpm-control input {
      width: 80px;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #444;
      background: #1a1a1a;
      color: white;
      font-size: 16px;
    }

    .bpm-control label {
      font-weight: 600;
    }

    .visualizer {
      background: #2a2a2a;
      padding: 30px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .step-indicator {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }

    .step {
      flex: 1;
      height: 60px;
      background: #3a3a3a;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #666;
      transition: all 0.05s ease-out;
      border: 2px solid transparent;
    }

    .step.active {
      background: #4CAF50;
      color: white;
      transform: scale(1.05);
      border-color: #66bb6a;
      box-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
    }

    .step.beat {
      border-color: #555;
    }

    .info {
      background: #2a2a2a;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .info-item {
      background: #1a1a1a;
      padding: 15px;
      border-radius: 4px;
    }

    .info-label {
      font-size: 12px;
      color: #888;
      margin-bottom: 5px;
    }

    .info-value {
      font-size: 24px;
      font-weight: 600;
      color: #4CAF50;
      font-family: 'Courier New', monospace;
    }

    .metrics {
      background: #2a2a2a;
      padding: 20px;
      border-radius: 8px;
    }

    .metrics h3 {
      margin-bottom: 15px;
      color: #4CAF50;
    }

    .metric-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #3a3a3a;
    }

    .metric-row:last-child {
      border-bottom: none;
    }

    .metric-label {
      color: #aaa;
    }

    .metric-value {
      font-family: 'Courier New', monospace;
      color: #fff;
    }

    .highlight {
      color: #4CAF50;
      font-weight: 600;
    }

    code {
      background: #1a1a1a;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      color: #4CAF50;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéµ Web Audio API Scheduler Demo</h1>
    <p class="subtitle">Precise 120 BPM timing using AudioContext scheduling</p>

    <div class="controls">
      <button id="playBtn">‚ñ∂ Start</button>
      <button id="stopBtn" class="stop">‚èπ Stop</button>
      
      <div class="bpm-control">
        <label for="bpmInput">BPM:</label>
        <input type="number" id="bpmInput" value="120" min="20" max="300" step="1">
      </div>
    </div>

    <div class="visualizer">
      <h3 style="margin-bottom: 15px;">16-Step Sequencer</h3>
      <div class="step-indicator" id="stepIndicator">
        <!-- Steps will be generated by JavaScript -->
      </div>
    </div>

    <div class="info">
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">Current Step</div>
          <div class="info-value" id="currentStep">-</div>
        </div>
        <div class="info-item">
          <div class="info-label">Audio Time (s)</div>
          <div class="info-value" id="audioTime">0.000</div>
        </div>
        <div class="info-item">
          <div class="info-label">Step Duration (ms)</div>
          <div class="info-value" id="stepDuration">125</div>
        </div>
        <div class="info-item">
          <div class="info-label">Queue Size</div>
          <div class="info-value" id="queueSize">0</div>
        </div>
      </div>
    </div>

    <div class="metrics">
      <h3>üìä Timing Architecture Metrics</h3>
      <div class="metric-row">
        <span class="metric-label">Timing Method:</span>
        <span class="metric-value highlight">AudioContext.currentTime</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">Scheduling Precision:</span>
        <span class="metric-value">~0.02ms (sample-accurate)</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">Schedule Ahead Time:</span>
        <span class="metric-value">100ms</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">Scheduler Loop Interval:</span>
        <span class="metric-value">25ms (setTimeout)</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">Visual Update Rate:</span>
        <span class="metric-value">~60fps (requestAnimationFrame)</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">vs. setInterval Jitter:</span>
        <span class="metric-value">¬±10-50ms (unreliable for audio)</span>
      </div>
    </div>
  </div>

  <script type="module">
    import AudioScheduler from './audio-scheduler.js';

    // Create scheduler instance
    const scheduler = new AudioScheduler(120, 4);

    // DOM elements
    const playBtn = document.getElementById('playBtn');
    const stopBtn = document.getElementById('stopBtn');
    const bpmInput = document.getElementById('bpmInput');
    const stepIndicator = document.getElementById('stepIndicator');
    const currentStepEl = document.getElementById('currentStep');
    const audioTimeEl = document.getElementById('audioTime');
    const stepDurationEl = document.getElementById('stepDuration');
    const queueSizeEl = document.getElementById('queueSize');

    // Generate step indicators
    for (let i = 0; i < 16; i++) {
      const step = document.createElement('div');
      step.className = 'step';
      if (i % 4 === 0) step.classList.add('beat');
      step.textContent = i + 1;
      step.dataset.step = i;
      stepIndicator.appendChild(step);
    }

    // Register step callback (for audio scheduling)
    scheduler.onStep((stepNumber, time) => {
      console.log(`Step ${stepNumber} scheduled at AudioContext time: ${time.toFixed(3)}s`);
      
      // In a real drum machine, this is where you'd trigger sounds:
      // if (pattern.kick[stepNumber]) kickSound.trigger(time);
      // if (pattern.snare[stepNumber]) snareSound.trigger(time);
      // etc.
    });

    // Register visual update callback
    scheduler.onVisualUpdate((stepNumber, time) => {
      // Remove previous active state
      document.querySelectorAll('.step').forEach(el => {
        el.classList.remove('active');
      });

      // Add active state to current step
      const currentStepEl = document.querySelector(`.step[data-step="${stepNumber}"]`);
      if (currentStepEl) {
        currentStepEl.classList.add('active');
      }

      // Update info display
      document.getElementById('currentStep').textContent = stepNumber;
    });

    // Update info display continuously
    function updateInfo() {
      if (scheduler.audioContext) {
        audioTimeEl.textContent = scheduler.audioContext.currentTime.toFixed(3);
      }
      
      const duration = (scheduler.getStepDuration() * 1000).toFixed(1);
      stepDurationEl.textContent = duration;
      
      queueSizeEl.textContent = scheduler.noteQueue.length;
      
      requestAnimationFrame(updateInfo);
    }
    updateInfo();

    // Play button
    playBtn.addEventListener('click', async () => {
      await scheduler.start();
      playBtn.textContent = '‚ñ∂ Playing...';
      playBtn.disabled = true;
      stopBtn.disabled = false;
    });

    // Stop button
    stopBtn.addEventListener('click', () => {
      scheduler.stop();
      playBtn.textContent = '‚ñ∂ Start';
      playBtn.disabled = false;
      stopBtn.disabled = false;
      
      // Clear visual indicators
      document.querySelectorAll('.step').forEach(el => {
        el.classList.remove('active');
      });
      currentStepEl.textContent = '-';
    });

    // BPM input
    bpmInput.addEventListener('input', (e) => {
      const bpm = parseInt(e.target.value);
      scheduler.setBPM(bpm);
    });

    // Initial state
    stopBtn.disabled = false;
  </script>
</body>
</html>
